# Block Contents Proof Design Document

## Table of Contents

1. [Purpose](#purpose)
2. [Goals](#goals)
3. [Terms](#terms)
4. [Entities](#entities)
5. [Design](#design)
6. [Sequence Diagram](#sequence-diagram)
7. [Configuration](#configuration)
8. [Metrics](#metrics)
9. [Exceptions](#exceptions)
10. [Acceptance Tests](#acceptance-tests)

## Purpose

The purpose of this document is to define the design of the BlockContentProof feature.
The BlockContentProof API allows the BN to provide a proof of the content of a block to the client.

## Goals

1. Define the BlockContentProof structure.
2. Define the BlockContentProof API
3. Given a BlockNumber and BlockItem (or BlockItemHash or BlockItemIndex) a BN should support the calculation of a BlockContentProof
4. A Client should be able to verify the BlockContentProof easily.

## Terms

<dl>
  <dt>BlockNumber</dt>
  <dd>A value that represents the unique number (identifier) of a given `Block`.
  It is a strictly increasing `long` value, starting from zero (`0`).</dd>

  <dt>BlockItem</dt>
  <dd>Each block item should be placed at their right location within the sub-merkle trees that form the block merkle tree. </dd>

  <dt>BlockItemHash</dt>
  <dd>Is the SHA-384 hash of the block_item </dd>

  <dt>MerkleSiblingHashes</dt>
  <dd>The ordered list of hashes for each "sibling" in the binary tree from the item to be proven all the way up to the tree root.</dd>

  <dt>BlockContentProof</dt>
  <dd>A data structure that holds all the needed information to prove a given block item is part of a given block number. It is comprised of the `BlockItem`, `MerkleSiblingHashes` and `BlockSignature`</dd>

  <dt>BlockRootHash</dt>
  <dd>The SHA2-384 value at the root of a carefully defined, partially truncated, binary merkle tree defined by the Block Streams HIP (1056).</dd>

  <dt>Block Signature</dt>
  <dd>A TSS signature of a BlockRootHash provided by the consensus network in a `BlockProof` item. Its purpose is to verify that the full content of a given block was generated by and agreed upon by the consensus network as a whole.</dd>

</dl>

## API

### block_proof_service.proto

```protobuf
 message BlockContentProof {
  com.hedera.hapi.block.stream.BlockItem block_item = 1;
  repeated MerkleSiblingHash sibling_hashes = 2;
  bytes block_signature = 3;
}

message BlockContentProofRequest {
    uint64 block_number = 1;
    oneof block_item {
        com.hedera.hapi.block.stream.BlockItem block_item = 1;
        bytes block_item_hash = 2;
        uint32 block_item_index = 3;
    }
}

enum BlockContentProofResponseCode {
    BLOCK_CONTENT_PROOF_UNKNOWN = 0;
    BLOCK_CONTENT_PROOF_SUCCESS = 1;
    BLOCK_CONTENT_PROOF_ITEM_NOT_FOUND = 2;
    BLOCK_CONTENT_PROOF_NOT_AVAILABLE = 3;
    BLOCK_CONTENT_PROOF_DUPLICATE_HASH_ITEM_FOUND = 4;
}

message BlockContentProofResponse {
    BlockContentProofResponseCode status = 1;
    com.hedera.hapi.block.stream.BlockContentProof block_content_proof = 2;
}

service BlockContentProofService {
    rpc getBlockContentProof(BlockContentProofRequest) returns (BlockContentProofResponse);
}
```

Full API specification found [here](https://github.com/hashgraph/hedera-protobufs/tree/main/block).

## Entities

### BlockContentProof

BlockContentProof is a new record that contains the fields necessary to compute the block content proof when combined with the retrieved block data.

### PBJBlockContentProofServiceProxy

PBJBlockContentProofServiceProxy is the entity responsible for handling the block content proof requests. It provides the implementation for the `getBlockContentProof` rpc endpoint.
Handles the verification of webServerStatus, handles exceptions, and transforms the response from the BlockContentProofService to a `BlockContentProofResponse` message.

### BlockContentProofService

A java module that embodies the functionality necessary to respond to request for block content proofs by calculating and returning those proofs

### BlockProvider

Shall provide a block to the BlockContentProofService at their request. `BlockContentProofService` will request a Block using a message request, and the `BlockProvider` will return the block.

### BlockMerkleTreeInfo

Is a record type that contains all the necessary data to compute any block item proof in the block.

## Design

1. The `PBJBlockContentProofServiceProxy` receives the block content proof requests.
2. If the request is valid and the web server is running, it forwards the request to the `BlockContentProofService`.
3. The `BlockContentProofService` publish a message requests for the block.
4. The `BlockProvider` provides the Block to the `BlockContentProofService`. If block is Available. This is a reference to a separate service or facility; the details of that reference are not within the scope of this design document.
5. `BlockContentProofService` uses the provided block to calculate a `BlockContentProof`.
6. The `BlockContentProofService` returns the `BlockContentProof` to the `PBJBlockContentProofServiceProxy`.
7. The `PBJBlockContentProofServiceProxy` wraps the `BlockContentProof` in a `BlockContentProofResponse` and sends it back to the client.

## Sequence Diagram

```mermaid
sequenceDiagram
    participant Client as Client
    participant Proxy as PBJBlockContentProofServiceProxy
    participant Service as BlockContentProofService
    participant Reader as BlockProvider

    Client->>Proxy:  BlockContentProofRequest
    Proxy->>Proxy:  Validates request & check web server status
    Proxy->>Service: BlockContentProofRequest
    Service->>Reader: Requests Block Number
    Reader-->>Service: Returns Block
    Service->>Service: Calculate BlockMerkleTreeInfo
    Service->>Service: Create BlockContentProof using BlockMerkleTreeInfo
    Service-->>Proxy: Return BlockContentProof
    Proxy->>Client: BlockContentProofResponse

```

## Configuration

## Metrics

1. BlockContentProofRequest_Success Counter
2. BlockContentProofRequest_Error Counter
3. BlockContentProofResponse_Latency Histogram

**Note:** Once we are able to add labels we should add `status` label to the metrics

## Exceptions

Any exception will be handled and return `BLOCK_CONTENT_PROOF_NOT_AVAILABLE` response code to the client.

## Acceptance Tests

### Happy Path:

1. Client sends a valid BlockContentProofRequest to the BN for an existing block and block_item.
2. BN receives the request and returns a complete BlockContentProofResponse
3. Client receives the BlockContentProofResponse and verifies the block_item using the BlockContentProof provided by the BN.

### Edge Case duplicate block_item (Failure Case):

1. Client sends a BlockContentProofRequest using `block_item_hash` to the BN for a block_item that has a duplicate hash in the block.
2. BN receives the request and returns a `BLOCK_CONTENT_PROOF_DUPLICATE_HASH_ITEM_FOUND` response code to the client.
3. Client receives the response and verify is the correct response code.

### Edge Case duplicate block_item (Success Case):

1. Client sends a BlockContentProofRequest using `block_item_index` to the BN for a block_item that has a duplicate hash in the block.
2. BN receives the request and returns a complete BlockContentProofResponse.
3. Client receives the BlockContentProofResponse and verifies the block_item using the BlockContentProof provided by the BN.
4. Client verifies that the block_item is the correct one by pre-calculating the merkle proof path before hand for the right item and then comparing the given proof with the expected proof.

### Block Number not found:

1. Client sends a BlockContentProofRequest to the BN for a non-existing block number.
2. BN receives the request and returns a `BLOCK_CONTENT_PROOF_NOT_AVAILABLE` response code to the client.

### Block item not found:

1. Client sends a BlockContentProofRequest to the BN for a non-existing block item. (variations of block_item, block_item_hash, block_item_index)
2. BN receives the request and returns a `BLOCK_CONTENT_PROOF_ITEM_NOT_FOUND` response code to the client.

### Block item hash is invalid:

1. Client sends a BlockContentProofRequest to the BN for a block_item with an invalid hash.
2. BN receives the request and returns a `BLOCK_CONTENT_PROOF_ITEM_NOT_FOUND` response code to the client.

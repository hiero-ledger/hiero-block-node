# SPDX-License-Identifier: Apache-2.0
# Hiero Network Topology Schema
# Extended from PR #1834 with mirror_nodes, relay_nodes, explorer_nodes

$schema: "https://json-schema.org/draft/2020-12/schema"
title: "Hiero Network Topology Schema"
type: object

$defs:
  nodeRef:
    type: string
    pattern: "^[a-zA-Z0-9_-]+$"

  nodeLink:
    type: object
    required: [node]
    properties:
      node: { $ref: "#/$defs/nodeRef" }
      priority: { type: integer, minimum: 1 }

  nodePriorityEntry:
    type: object
    minProperties: 1
    maxProperties: 1
    additionalProperties: { type: integer, minimum: 1 }

  address: { type: string }
  port: { type: integer, minimum: 1, maximum: 65535 }

  nodeRefList:
    type: array
    minItems: 1
    items:
      anyOf:
        - { $ref: "#/$defs/nodeRef" }
        - { $ref: "#/$defs/nodeLink" }
        - { $ref: "#/$defs/nodePriorityEntry" }

  # gRPC client tuning for backfill connections
  grpcTuning:
    type: object
    description: "gRPC WebClient tuning for backfill connections to this node"
    properties:
      max_frame_size:
        type: integer
        minimum: 16384
        maximum: 16777215
        description: "HTTP/2 max frame size in bytes (default: 4MB, range: 16KB-16MB per RFC 7540)"
      initial_window_size:
        type: integer
        minimum: 1
        maximum: 2147483647
        description: "HTTP/2 initial window size for flow control (default: 4MB)"
      initial_buffer_size:
        type: integer
        minimum: 1024
        maximum: 67108864
        description: "gRPC initial buffer size in bytes (default: 4MB, range: 1KB-64MB)"
      connect_timeout:
        type: integer
        minimum: 100
        maximum: 300000
        description: "Connection timeout in milliseconds (default: 10000)"
      read_timeout:
        type: integer
        minimum: 100
        maximum: 300000
        description: "Read timeout in milliseconds (default: 10000)"

properties:
  name:
    type: string
    description: "Topology identifier (matches filename without .yaml)"

  description:
    type: string
    description: "Human-readable description"

  block_nodes:
    type: object
    description: "Block nodes that receive streams from consensus nodes"
    patternProperties:
      "^[a-zA-Z0-9_-]+$":
        type: object
        required: [address, port]
        properties:
          address: { $ref: "#/$defs/address" }
          port: { $ref: "#/$defs/port" }
          priority: { type: integer, minimum: 1 }
          peers:
            type: array
            items:
              anyOf:
                - { $ref: "#/$defs/nodeRef" }
                - { $ref: "#/$defs/nodeLink" }
                - { $ref: "#/$defs/nodePriorityEntry" }
          greedy:
            type: boolean
            description: "Enable greedy backfill mode (defaults to false)"
          grpc_tuning:
            $ref: "#/$defs/grpcTuning"

  consensus_nodes:
    type: object
    description: "Consensus nodes that produce block streams"
    patternProperties:
      "^[a-zA-Z0-9_-]+$":
        type: object
        required: [block_nodes]
        properties:
          block_nodes: { $ref: "#/$defs/nodeRefList" }

  mirror_nodes:
    type: object
    description: "Mirror nodes that subscribe to block nodes"
    patternProperties:
      "^[a-zA-Z0-9_-]+$":
        type: object
        required: [block_nodes]
        properties:
          address: { $ref: "#/$defs/address" }
          port: { $ref: "#/$defs/port" }
          grpc_port: { $ref: "#/$defs/port" }
          block_nodes: { $ref: "#/$defs/nodeRefList" }

  relay_nodes:
    type: object
    description: "JSON-RPC relay nodes that connect to mirror nodes"
    patternProperties:
      "^[a-zA-Z0-9_-]+$":
        type: object
        required: [mirror_nodes]
        properties:
          mirror_nodes: { $ref: "#/$defs/nodeRefList" }

  explorer_nodes:
    type: object
    description: "Explorer UI nodes that display data from mirror nodes"
    patternProperties:
      "^[a-zA-Z0-9_-]+$":
        type: object
        required: [mirror_nodes]
        properties:
          mirror_nodes: { $ref: "#/$defs/nodeRefList" }

required: [name, block_nodes, consensus_nodes]
additionalProperties: false

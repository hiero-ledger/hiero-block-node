# SPDX-License-Identifier: Apache-2.0
#
# Node Restart Resilience Test
#
# Validates that the Block Node recovers correctly after a restart.
# Tests resilience, data integrity, and backfill capability.
#
# Prerequisites:
#   - Topology "single" deployed (task up)
#   - Port forwards active (task port-forward)
#
# Usage:
#   task test:run TEST_FILE=tests/node-restart-resilience.yaml

name: node-restart-resilience
description: "Test BN recovery after restart"

events:
  - id: early-metrics
    type: print-metrics
    description: "Print early metrics"
    delay: 10
    args:
      target: block-node-1

  - id: pre-restart-metrics
    type: print-metrics
    description: "Print metrics before restart"
    delay: 30
    args:
      target: block-node-1

  - id: restart-bn
    type: restart
    description: "Restart Block Node"
    delay: 60
    target: block-node-1
    timeout: 300

  - id: refresh-ports
    type: port-forward
    description: "Refresh port forwards after restart"
    delay: 90

  - id: post-restart-status
    type: network-status
    description: "Check network status after restart"
    delay: 120

  - id: post-restart-metrics
    type: print-metrics
    description: "Print metrics after restart recovery"
    delay: 150
    args:
      target: block-node-1

  - id: final-metrics
    type: print-metrics
    description: "Print final metrics"
    delay: 180
    args:
      target: block-node-1

assertions:
  - id: bn1-recovered
    type: node-healthy
    description: "Block Node 1 recovered and is healthy"
    target: block-node-1

  - id: bn1-has-blocks
    type: block-available
    description: "Block Node 1 has blocks after recovery"
    target: block-node-1
    args:
      min_block: 0

  - id: no-verify-errors
    type: no-errors
    description: "No verification errors after restart"
    target: block-node-1

  - id: bn1-blocks-increasing
    type: blocks-increasing
    description: "Block Node is receiving new blocks after restart"
    target: block-node-1
    args:
      wait_seconds: 70
